<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommU⇆</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=2.2.1">
    
    <!-- キャッシュ制御用メタタグ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <!-- デバッグ情報表示エリア -->
    <div id="device-info" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px; font-size: 10px; border-radius: 5px; z-index: 1000; display: none;">
        <div>UA: <span id="user-agent"></span></div>
        <div>Bluetooth: <span id="bluetooth-support"></span></div>
        <div>HTTPS: <span id="https-status"></span></div>
    </div>

    <div id="app">
        <!-- 接続方法選択画面 -->
        <div id="connection-screen" class="screen active">
            <div class="container">
                <h1 class="app-title">CommU⇆</h1>
                <p class="subtitle">接続方法を選んでください</p>
                <div class="version-info">
                    <span>バージョン: </span><span id="app-version">2.2.1</span>
                    <span class="version-status" id="version-status">確認中...</span>
                </div>
                
                <div class="connection-methods">
                    <button class="connection-method-btn qr-btn" id="qr-connection">
                        <div class="method-icon">📱</div>
                        <span class="method-title">QRコード接続</span>
                        <span class="method-desc">カメラでQRコードを読み取り</span>
                    </button>
                    <button class="connection-method-btn bluetooth-btn" id="bluetooth-connection">
                        <div class="method-icon">📡</div>
                        <span class="method-title">Bluetooth接続</span>
                        <span class="method-desc">近距離無線通信</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Bluetooth接続画面 -->
        <div id="bluetooth-screen" class="screen">
            <div class="container">
                <h2>Bluetooth接続</h2>
                <p class="subtitle">デバイス同士をつなげましょう</p>
                
                <!-- 環境チェック情報 -->
                <div id="environment-check" style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; font-size: 0.9rem;">
                    <div id="bluetooth-check">🔍 Bluetooth対応: 確認中...</div>
                    <div id="https-check">🔒 HTTPS: 確認中...</div>
                    <div id="browser-check">🌐 ブラウザ: 確認中...</div>
                </div>
                
                <div class="button-group">
                    <button class="primary-btn" id="host-btn">ホストになる</button>
                    <button class="secondary-btn" id="connect-btn">相手とつながる</button>
                    <button class="secondary-btn" id="back-to-connection">戻る</button>
                </div>
                
                <!-- テスト用ボタン -->
                <div style="margin-top: 20px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                    <p style="font-size: 0.8rem; margin-bottom: 10px;">テスト・デバッグ機能:</p>
                    <button class="secondary-btn" id="show-device-info" style="margin: 5px; padding: 8px 12px; font-size: 0.8rem;">端末情報表示</button>
                    <button class="secondary-btn" id="test-bluetooth" style="margin: 5px; padding: 8px 12px; font-size: 0.8rem;">Bluetoothテスト</button>
                    <button class="secondary-btn" id="demo-mode" style="margin: 5px; padding: 8px 12px; font-size: 0.8rem;">デモモード</button>
                    <button class="secondary-btn" id="clear-cache" style="margin: 5px; padding: 8px 12px; font-size: 0.8rem;">キャッシュクリア</button>
                </div>
            </div>
        </div>

        <!-- QRコード接続画面 -->
        <div id="qr-screen" class="screen">
            <div class="container">
                <h2>QRコード接続</h2>
                <div id="qr-host-section" class="qr-section hidden">
                    <p class="subtitle">このQRコードを相手に読み取ってもらってください</p>
                    <div class="qr-container">
                        <canvas id="qr-canvas" width="256" height="256"></canvas>
                    </div>
                    <div class="connection-info">
                        <p>接続ID: <span id="connection-id"></span></p>
                        <p class="status-text" id="host-status">相手の接続を待っています...</p>
                    </div>
                </div>
                
                <div id="qr-client-section" class="qr-section hidden">
                    <p class="subtitle">相手のQRコードをカメラで読み取ってください</p>
                    <div class="camera-container">
                        <video id="camera-video" autoplay playsinline></video>
                        <div class="scan-overlay">
                            <div class="scan-line"></div>
                        </div>
                    </div>
                    <div class="camera-controls">
                        <button class="secondary-btn" id="toggle-camera">カメラ切替</button>
                        <button class="secondary-btn" id="manual-input-btn">手動入力</button>
                    </div>
                    <div class="manual-input hidden" id="manual-input">
                        <input type="text" id="manual-connection-id" placeholder="接続IDを入力">
                        <button class="primary-btn" id="manual-connect-btn">接続</button>
                    </div>
                    <p class="status-text" id="client-status">QRコードをスキャンしてください</p>
                </div>

                <div id="qr-role-selection" class="qr-section">
                    <div class="button-group">
                        <button class="primary-btn" id="qr-host-btn">QRコードを生成</button>
                        <button class="secondary-btn" id="qr-scan-btn">QRコードを読み取り</button>
                        <button class="secondary-btn" id="back-from-qr">戻る</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 役割選択画面 -->
        <div id="role-screen" class="screen">
            <div class="container">
                <h2>役割を選んでください</h2>
                <div class="role-buttons">
                    <button class="role-btn questioner-btn" id="questioner-role">
                        <div class="role-icon">❓</div>
                        <span>質問する人になる</span>
                    </button>
                    <button class="role-btn answerer-btn" id="answerer-role">
                        <div class="role-icon">💭</div>
                        <span>答える人になる</span>
                    </button>
                    <button class="role-btn sound-btn" id="sound-role">
                        <div class="role-icon">🔊</div>
                        <span>言葉で質問・音で回答</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ルーム作成画面 -->
        <div id="room-create-screen" class="screen">
            <div class="container">
                <h2>ルームを作成</h2>
                <p>5桁のルームIDを決めてください</p>
                <div class="room-id-display">
                    <span id="room-id-input">-----</span>
                </div>
                <div class="numpad">
                    <button class="num-btn" data-num="1">1</button>
                    <button class="num-btn" data-num="2">2</button>
                    <button class="num-btn" data-num="3">3</button>
                    <button class="num-btn" data-num="4">4</button>
                    <button class="num-btn" data-num="5">5</button>
                    <button class="num-btn" data-num="6">6</button>
                    <button class="num-btn" data-num="7">7</button>
                    <button class="num-btn" data-num="8">8</button>
                    <button class="num-btn" data-num="9">9</button>
                    <button class="num-btn clear-btn">クリア</button>
                    <button class="num-btn" data-num="0">0</button>
                    <button class="num-btn random-btn">ランダム</button>
                </div>
                <div class="button-group">
                    <button class="primary-btn" id="create-room-btn" disabled>ルームを作成</button>
                    <button class="secondary-btn" id="back-to-role-btn">戻る</button>
                </div>
            </div>
        </div>

        <!-- ルーム参加画面 -->
        <div id="room-join-screen" class="screen">
            <div class="container">
                <h2>ルームを選択</h2>
                <div id="room-list" class="room-list">
                    <!-- ルーム一覧が動的に生成される -->
                </div>
                <button class="secondary-btn" id="back-to-role-btn2">戻る</button>
            </div>
        </div>

        <!-- 質問者画面 -->
        <div id="questioner-screen" class="screen">
            <div class="container">
                <div class="room-info">
                    <span>ルーム: <span id="current-room-id"></span></span>
                    <button class="exit-btn" id="exit-room-btn">退出</button>
                </div>
                
                <div id="waiting-message" class="waiting-message">
                    回答者を待っています...
                </div>

                <div id="questioner-content" class="hidden">
                    <div class="history-section">
                        <h3>やりとり履歴</h3>
                        <div id="chat-history" class="chat-history"></div>
                    </div>

                    <div class="question-section">
                        <div class="animation-selector">
                            <label>アニメーション:</label>
                            <select id="animation-select">
                                <option value="none">なし</option>
                                <option value="typewriter">タイプライター</option>
                                <option value="wave">波</option>
                                <option value="fadeIn">フェードイン</option>
                                <option value="jump">ジャンプ</option>
                                <option value="spin">スピン</option>
                            </select>
                        </div>
                        <textarea id="question-input" placeholder="質問を入力してください"></textarea>
                        <button class="primary-btn" id="send-question-btn">質問を送信</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 回答者画面 -->
        <div id="answerer-screen" class="screen">
            <div class="container">
                <div class="room-info">
                    <span>ルーム: <span id="current-room-id-answerer"></span></span>
                    <button class="exit-btn" id="exit-room-btn-answerer">退出</button>
                </div>

                <div id="waiting-question" class="waiting-message">
                    質問を待っています...
                </div>

                <div id="answerer-content" class="hidden">
                    <div class="message-section">
                        <textarea id="free-message-input" placeholder="質問者にメッセージを送れます（「やっほー」「眠いよー！」「○○の質問は答えづらいかも…」など）"></textarea>
                        <button class="secondary-btn" id="send-message-btn">メッセージ送信</button>
                    </div>

                    <div class="question-display">
                        <h3>質問</h3>
                        <div id="question-text" class="question-text"></div>
                    </div>

                    <div class="answer-section">
                        <div class="answer-customize">
                            <button class="customize-btn" id="customize-yes">はい</button>
                            <button class="customize-btn" id="customize-no">いいえ</button>
                        </div>
                        
                        <div class="sound-selector">
                            <label>効果音:</label>
                            <select id="sound-select">
                                <option value="none">なし</option>
                                <option value="ping">ピンポン</option>
                                <option value="buzz">ブブッ</option>
                                <option value="sparkle">きらきら</option>
                                <option value="don">デーン…</option>
                                <option value="deden">デデン！</option>
                            </select>
                        </div>

                        <div class="answer-buttons">
                            <button class="answer-btn yes-btn" id="answer-yes">はい</button>
                            <button class="answer-btn no-btn" id="answer-no">いいえ</button>
                            <button class="answer-btn maybe-btn" id="answer-maybe">わからない</button>
                            <button class="answer-btn refuse-btn" id="answer-refuse">答えたくない</button>
                        </div>

                        <div class="text-answer-section">
                            <textarea id="text-answer-input" placeholder="テキストで回答する場合はこちらに入力"></textarea>
                            <button class="secondary-btn" id="send-text-answer-btn">テキスト回答を送信</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 音響モード画面 -->
        <div id="sound-mode-screen" class="screen">
            <div class="container">
                <h2>音響モード</h2>
                <div class="sound-mode-toggle">
                    <label>
                        <input type="checkbox" id="voice-synthesis-toggle">
                        合成音声を使用
                    </label>
                </div>
                <div class="sound-answer-buttons">
                    <button class="sound-answer-btn" data-answer="yes">はい</button>
                    <button class="sound-answer-btn" data-answer="no">いいえ</button>
                    <button class="sound-answer-btn" data-answer="maybe">わからない</button>
                    <button class="sound-answer-btn" data-answer="refuse">答えたくない</button>
                </div>
                <button class="secondary-btn" id="back-from-sound">戻る</button>
            </div>
        </div>

        <!-- カスタマイズモーダル -->
        <div id="customize-modal" class="modal">
            <div class="modal-content">
                <h3 id="customize-title">ボタンをカスタマイズ</h3>
                <div class="customize-options">
                    <button class="customize-option" data-value="0"></button>
                    <button class="customize-option" data-value="1"></button>
                    <button class="customize-option" data-value="2"></button>
                </div>
                <button class="secondary-btn" id="close-customize">閉じる</button>
            </div>
        </div>

        <!-- エクスポートモーダル -->
        <div id="export-modal" class="modal">
            <div class="modal-content">
                <h3>やりとりをエクスポート</h3>
                <p>ルームから退出するとやりとりの履歴は消去されます</p>
                <div class="export-buttons">
                    <button class="primary-btn" id="export-txt">TXTでダウンロード</button>
                    <button class="primary-btn" id="export-csv">CSVでダウンロード</button>
                    <button class="primary-btn" id="export-email">メールで送信</button>
                    <button class="secondary-btn" id="skip-export">エクスポートしない</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // キャッシュクリア機能
    function clearAllCaches() {
        if ('caches' in window) {
            caches.keys().then(cacheNames => {
                return Promise.all(
                    cacheNames.map(cacheName => {
                        console.log('Deleting cache:', cacheName);
                        return caches.delete(cacheName);
                    })
                );
            }).then(() => {
                console.log('All caches cleared');
                window.location.reload(true);
            });
        }
    }

    // Service Worker更新チェック
    function checkForUpdates() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
                registration.update();
                
                // バージョン情報を取得
                const messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = function(event) {
                    const currentVersion = '2.2.1';
                    const swVersion = event.data.version;
                    const versionStatus = document.getElementById('version-status');
                    
                    if (swVersion === currentVersion) {
                        versionStatus.textContent = '最新版';
                        versionStatus.className = 'version-status latest';
                    } else {
                        versionStatus.textContent = '更新あり';
                        versionStatus.className = 'version-status update-available';
                    }
                };
                
                if (registration.active) {
                    registration.active.postMessage({type: 'GET_VERSION'}, [messageChannel.port2]);
                }
            });
        }
    }

    // 環境チェック機能
    document.addEventListener('DOMContentLoaded', () => {
        // 基本環境情報の表示
        function updateEnvironmentCheck() {
            // Bluetooth対応チェック
            const bluetoothCheck = document.getElementById('bluetooth-check');
            if ('bluetooth' in navigator) {
                bluetoothCheck.textContent = '🔍 Bluetooth対応: ✅ サポートされています';
                bluetoothCheck.style.color = '#4CAF50';
            } else {
                bluetoothCheck.textContent = '🔍 Bluetooth対応: ❌ サポートされていません';
                bluetoothCheck.style.color = '#F44336';
            }

            // HTTPS チェック
            const httpsCheck = document.getElementById('https-check');
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                httpsCheck.textContent = '🔒 HTTPS: ✅ セキュア環境';
                httpsCheck.style.color = '#4CAF50';
            } else {
                httpsCheck.textContent = '🔒 HTTPS: ❌ 非セキュア環境';
                httpsCheck.style.color = '#F44336';
            }

            // ブラウザチェック
            const browserCheck = document.getElementById('browser-check');
            const userAgent = navigator.userAgent;
            if (userAgent.includes('Chrome') && !userAgent.includes('Edge')) {
                browserCheck.textContent = '🌐 ブラウザ: ✅ Chrome (推奨)';
                browserCheck.style.color = '#4CAF50';
            } else if (userAgent.includes('Edge')) {
                browserCheck.textContent = '🌐 ブラウザ: ⚠️ Edge (対応)';
                browserCheck.style.color = '#FF9800';
            } else {
                browserCheck.textContent = '🌐 ブラウザ: ❌ 未対応の可能性';
                browserCheck.style.color = '#F44336';
            }
        }

        updateEnvironmentCheck();
        checkForUpdates();

        // 端末情報表示
        document.getElementById('show-device-info').addEventListener('click', () => {
            const deviceInfo = document.getElementById('device-info');
            const isVisible = deviceInfo.style.display !== 'none';
            
            if (isVisible) {
                deviceInfo.style.display = 'none';
            } else {
                document.getElementById('user-agent').textContent = navigator.userAgent.substring(0, 50) + '...';
                document.getElementById('bluetooth-support').textContent = !!navigator.bluetooth ? 'YES' : 'NO';
                document.getElementById('https-status').textContent = location.protocol === 'https:' ? 'YES' : 'NO';
                deviceInfo.style.display = 'block';
            }
        });

        // Bluetoothテスト
        document.getElementById('test-bluetooth').addEventListener('click', async () => {
            if (!navigator.bluetooth) {
                alert('❌ Bluetooth APIがサポートされていません\n\n- HTTPS環境で実行してください\n- Chrome/Edgeを使用してください');
                return;
            }

            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['battery_service', 'device_information']
                });
                alert(`✅ Bluetoothデバイスが検出されました!\n\nデバイス名: ${device.name || '不明'}\nID: ${device.id}`);
            } catch (error) {
                alert(`❌ Bluetoothテストに失敗しました\n\nエラー: ${error.name}\nメッセージ: ${error.message}`);
            }
        });

        // デモモード
        document.getElementById('demo-mode').addEventListener('click', () => {
            alert('📱 デモモードを開始します\n\nBluetooth接続なしでUIをテストできます');
            // アプリの初期化は既存のコードで実行される
        });

        // キャッシュクリア
        document.getElementById('clear-cache').addEventListener('click', () => {
            if (confirm('🗑️ キャッシュをクリアして最新版を取得しますか？\n\nページが自動的に再読み込みされます。')) {
                clearAllCaches();
            }
        });
    });
    </script>

    <script src="qr-utils.js?v=2.2.1"></script>
    <script src="app.js?v=2.2.1"></script>
</body>
</html>